"use strict";window.tsfMedia=function(){function a(a){const c=a.target;if(c.disabled||"undefined"==typeof wp.media)return a.preventDefault(),void a.stopPropagation();const f=c.dataset.inputType||"",g=c.dataset.inputId||"";let h;a.preventDefault(),a.stopPropagation(),d();const i={suggestedWidth:+(c.dataset.width||1200),suggestedHeight:+(c.dataset.height||630),isFlex:+(c.dataset.flex||1),minWidth:+(c.dataset.minWidth||200),minHeight:+(c.dataset.minHeight||200)};o.control={params:{flex_width:i.isFlex?4096:0,flex_height:i.isFlex?4096:0,width:i.suggestedWidth,height:i.suggestedHeight,isFlex:i.isFlex,minWidth:i.minWidth,minHeight:i.minHeight}},h=wp.media({button:{text:n.labels[f].imgFrameButton,close:!1},states:[new wp.media.controller.Library({title:n.labels[f].imgFrameTitle,library:wp.media.query({type:"image"}),multiple:!1,date:!1,priority:20,suggestedWidth:i.suggestedWidth,suggestedHeight:i.suggestedHeight}),new o({imgSelectOptions:e})]});const j=document.getElementById(`${g}-url`),k=document.getElementById(`${g}-id`),l=()=>{h.setState("cropper")};h.off("select",l),h.on("select",l);const m=a=>{let b=a.url,c=a.id;j&&(j.value=b,j.dispatchEvent(new Event("change"))),k&&(k.value=c,k.dispatchEvent(new Event("change")))};h.off("cropped",m),h.on("cropped",m);const p=a=>{let b=a.get("url"),c=a.get("id");j&&(j.value=b,j.dispatchEvent(new Event("change"))),k&&(k.value=c,k.dispatchEvent(new Event("change")))};h.off("skippedcrop",p),h.on("skippedcrop",p);const q=()=>{c.textContent=n.labels[f].imgChange,j&&(j.readOnly=!0),b(c,!0),"tsfAys"in window&&tsfAys.registerChange()};h.off("skippedcrop cropped",q),h.on("skippedcrop cropped",q),h.open()}function b(a,b){const c=a.dataset?.inputId,d=a.dataset?.inputType;if(c&&d&&!document.getElementById(`${c}-remove`)){const e=document.createElement("button");e.type="button",e.id=`${c}-remove`,e.dataset.inputId=c,e.dataset.inputType=d,e.title=tsf.decodeEntities(n.labels[d].imgRemoveTitle),e.innerHTML=tsf.escapeString(tsf.decodeEntities(n.labels[d].imgRemove)),e.classList.add("tsf-remove-image-button",...(JSON.parse(a.dataset?.buttonClass||0)?.remove||[])),a.insertAdjacentElement("afterend",e),b&&tsfUI.fadeIn(e,250),j()}}function c(a){const b=a.target.dataset.inputId,c=a.target.dataset.inputType;if(!b||!c)return;const d=document.getElementById(`${b}-select`);if(d.disabled)return;d.disabled=!0,d.classList.add("disabled");const e=document.getElementById(`${b}-remove`);e&&(e.disabled=!0,e.classList.add("disabled"),tsfUI.fadeOut(e,125,()=>{e.remove(),d.textContent=n.labels[c].imgSelect,d.classList.remove("disabled"),d.disabled=!1}));const f=document.getElementById(`${b}-url`);f&&(f.value="",f.dispatchEvent(new Event("change")),!f.dataset.readonly&&(f.readOnly=!1));const g=document.getElementById(`${b}-id`);g&&(g.value="",g.dispatchEvent(new Event("change"))),"tsfAys"in window&&tsfAys.registerChange()}function d(){if("undefined"!=typeof o.control)return;const a=wp.media.view,b=a.Cropper.extend({className:"crop-content tsf-image",ready:function(){a.Cropper.prototype.ready.apply(this,arguments)},onImageLoad:function(){let a,b=this.controller.get("imgSelectOptions");"function"==typeof b&&(b=b(this.options.attachment,this.controller)),"undefined"==typeof b.aspectRatio&&(b=Object.assign(b,{parent:this.$el,onInit:function(){this.parent.children().on("mousedown touchstart",function(b){b.shiftKey?a.setOptions({aspectRatio:"1:1"}):a.setOptions({aspectRatio:!1})})}})),this.trigger("image-loaded"),a=this.controller.imgSelect=this.$image.imgAreaSelect(b)}}),c=wp.media.controller.Cropper.extend({createCropContent:function(){this.cropperView=new b({controller:this,attachment:this.get("selection").first()}),this.cropperView.on("image-loaded",this.createCropToolbar,this),this.frame.content.set(this.cropperView)},doCrop:function(a){var b=Math.round;let c=a.get("cropDetails"),d=o.control;if(d.params.flex_width&&d.params.flex_height)if(c.width===c.height)c.width>d.params.flex_width&&(c.dst_width=c.dst_height=d.params.flex_width);else if(c.width>d.params.flex_width||c.height>d.params.flex_height)if(c.width>c.height){let a=c.width/d.params.flex_width;c.dst_width=d.params.flex_width,c.dst_height=b(c.height/a)}else{let a=c.height/d.params.flex_height;c.dst_height=d.params.flex_height,c.dst_width=b(c.width/a)}return"undefined"==typeof c.dst_width&&(c.dst_width=0,c.dst_height=0),wp.ajax.post("tsf_crop_image",{nonce:n.nonce,id:a.get("id"),context:"tsf-image",cropDetails:c})}});c.prototype.control={},o=c}function e(a,b){const c=o.control;let d=parseInt(c.params.width,10),e=parseInt(c.params.height,10);const g=!!parseInt(c.params.flex_width,10),h=!!parseInt(c.params.flex_height,10),i=a.get("width"),j=a.get("height"),k=d/e,l=d,m=e;let n;n=c.params.isFlex?!f(c.params.flex_width,c.params.flex_height,i,j):k===i/j,b.set("control",c.params),b.set("canSkipCrop",n),i/j>k?(e=j,d=e*k):(d=i,e=d/k);let p=(i-d)/2,q=(j-e)/2;const r={handles:!0,keys:!0,instance:!0,persistent:!0,imageWidth:i,imageHeight:j,minWidth:l>d?d:l,minHeight:m>e?e:m,x1:p,y1:q,x2:d+p,y2:e+q};return c.params.isFlex?h||g?(h&&(r.minHeight=c.params.minHeight,r.maxWidth=i),g&&(r.minWidth=c.params.minWidth,r.maxHeight=j)):r.aspectRatio=`${d}:${e}`:(r.handles="corners",r.aspectRatio=`${d}:${e}`),r}function f(a,b,c,d){return c>a||d>b}function g(a){const b=a.target.dataset.id||"",c=a.target.dataset.type||"";if(b&&c){const d=document.getElementById(`${b}-select`);d.disabled||(d.textContent=a.target.value.length?n.labels[c].imgChange:n.labels[c].imgSelect)}}function h(){document.querySelectorAll(".tsf-set-image-button").forEach(a=>{const c=a.dataset.inputId||"",d=c&&document.getElementById(`${c}-id`),e=c&&document.getElementById(`${c}-url`);d&&0<d.value&&(e&&(e.readOnly=!0),b(a,!1)),e&&(e.addEventListener("change",g),e.dispatchEvent(new Event("change")))})}function i(){document.querySelectorAll(".tsf-set-image-button").forEach(b=>{b.addEventListener("click",a)})}function j(){document.querySelectorAll(".tsf-remove-image-button").forEach(a=>{a.addEventListener("click",c)})}function k(){i(),j(),document.querySelectorAll(".tsf-enable-media-if-js").forEach(a=>{a.disabled=!1,a.classList.remove("tsf-enable-media-if-js")}),h(),m()}function l(a){const b=a.target.id?.replace(/-[a-z]+$/,"");if(!b)return;const c=document.getElementById(`${b}-preview`),d=document.getElementById(`${b}-image-warning`);p.has(b)&&clearTimeout(p.get(b));const e=!(a.target.dataset.tsfNotificationsLoaded||!1);let f=a.target.value||a.target.placeholder||"";const g=a=>{e?(a.classList.remove("hidden"),a.style.opacity="1"):a.classList.contains("hidden")&&(a.classList.remove("hidden"),tsfUI.fadeIn(a)),tsfTT.triggerUpdate(a)},h=a=>{a.classList.add("hidden"),a.style.opacity="0"},i=()=>{if(!f.length)return void[c,d].forEach(h);let b=Date.now();a.target.dataset.tsfCurrentInputTime=b;const e=new Image,i=f=>{if(b!==+a.target.dataset.tsfCurrentInputTime)return;let i="",j="warning";if(c&&(f?(e.style="max-width:225px;max-height:225px;min-width:60px;min-height:60px;border-radius:3px;display:block;",c.dataset.desc=e.outerHTML,g(c)):(i=n.warning.i18n.notLoaded,j="error",h(c))),d){if(!i.length){let a=e.src.length&&e.src.split(".").pop().toLowerCase();a.length&&(n.warning.warnedTypes.hasOwnProperty(a)?i=n.warning.i18n.extWarned.replace("%s",tsf.escapeString(a)):n.warning.forbiddenTypes.hasOwnProperty(a)&&(i=n.warning.i18n.extForbidden.replace("%s",tsf.escapeString(a)),j="error"))}i.length?(d.classList.toggle("tsf-media-warning","warning"===j),d.classList.toggle("tsf-media-error","error"===j),d.dataset.desc=i,g(d)):h(d)}};let j=!1;e.onload=()=>{i(!0),j=!0},e.onerror=()=>{i(!1),j=!0},setTimeout(()=>{j||(e.src="",i(!1))},7e3),e.src=f};a.target.dataset.tsfNotificationsLoaded=!0,p.set(b,setTimeout(i,e&&0?f.length:1e3/(115/60)))}function m(){document.querySelectorAll(".tsf-image-notifications").forEach(a=>{const b=document.getElementById(`${a.dataset.for}-url`);b&&(b.addEventListener("input",l),b.addEventListener("change",l),b.dispatchEvent(new Event("change")))})}const n=tsfMediaL10n;let o={},p=new Map;const q=tsfUtils.debounce(k,500);return Object.assign({load:()=>{document.body.addEventListener("tsf-ready",k)}},{resetImageEditorActions:q},{l10n:n})}(),window.tsfMedia.load();
